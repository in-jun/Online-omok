<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>온라인오목</title>
    <style>
        body {
            -ms-overflow-style: none;
        }

        ::-webkit-scrollbar {
            display: none;
        }

        #canvas {
            display: block;
            box-shadow: 5px 5px 10px 5px #00000026;
            border-radius: 10px;
            border: 2px solid #00000075;
            margin: auto;
        }

        #output {
            text-align: center;
            background-color: #c0deffa6;
            padding: 0.1em;
            border-radius: 8px;
            border: 2px solid #00000075;
            width: 40%;
            margin: auto;
            margin-top: 10px;
            font-size: 2em;
        }
    </style>
</head>

<body>
    <canvas id='canvas'></canvas>
    <h1 id='output'></h1>

    <script language="javascript" type="text/javascript">
        window.onload = function () {
            // WebSocket 설정
            const socket = new WebSocket('ws' + (location.protocol === 'https:' ? 's' : '') + '://' + window.location.host + '/ws');

            // 게임 변수
            var check = new Array(225);
            var myTurn = false;
            var myColor;
            var yourColor;

            // 보드 설정
            var margin;
            var boardSize;

            // 오디오 요소
            var audio1 = new Audio("SOUND/stone.mp3");
            var audio2 = new Audio("SOUND/enter.mp3");

            // 캔버스 설정
            canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d');
            setCanvasSize();

            // WebSocket 이벤트 핸들러
            socket.onopen = function (evt) {
                initializeBoard();
                writing("유저 매칭중.....");

                document.addEventListener('mouseup', function (event) {
                    if (event.target.id == 'canvas' && myTurn) {
                        handleCanvasClick(event);
                    }
                });
            };

            socket.onmessage = function (event) {
                handleSocketMessage(event);
            };

            socket.onclose = function (evt) {
                handleSocketClose();
            };

            // 캔버스 크기 설정 함수
            function setCanvasSize() {
                if (window.matchMedia('(orientation: portrait)').matches) {
                    canvas.height = canvas.width = window.innerWidth * 0.9;
                } else {
                    canvas.height = canvas.width = window.innerHeight * 0.9;
                }
                margin = canvas.width / 35;
                boardSize = (canvas.width - (margin * 2)) / 14;
            }

            // 보드 초기화 함수
            function initializeBoard() {
                for (var x = 0; x < 14; x++) {
                    for (var y = 0; y < 14; y++) {
                        ctx.strokeStyle = "red";
                        ctx.lineWidth = 1;
                        ctx.strokeRect(
                            boardSize * x + margin,
                            boardSize * y + margin,
                            boardSize,
                            boardSize
                        );
                    }
                }
            }

            // 캔버스 클릭 이벤트 처리 함수
            function handleCanvasClick(event) {
                var x = Math.round(Math.abs(event.offsetX - 20) / boardSize);
                var y = Math.round(Math.abs(event.offsetY - 20) / boardSize);

                if (!check[x + y * 15]) {
                    check[x + y * 15] = true;
                    draw(x + y * 15, myColor);
                    socket.send(x + y * 15);
                    myTurn = false;
                }
            }

            // WebSocket 메시지 처리 함수
            function handleSocketMessage(event) {
                const message = JSON.parse(event.data);

                if (message.data != "") {
                    check[message.data] = true;
                    draw(message.data, yourColor);
                    myTurn = true;
                } else {
                    handleInitialConnection(message);
                }
            }

            // 초기 연결 처리 함수
            function handleInitialConnection(message) {
                if (message.YourColor != "") {
                    audio2.play();
                    myColor = message.YourColor;
                    startTimer(myColor == "black" ? "흑돌" : "백돌");
                    yourColor = (myColor == "black" ? "white" : "black");
                    setInitialConditions(myColor);
                } else {
                    setTimeout(function () {
                        alert(message.message);
                    }, 500);
                }
            }

            // 플레이어 색에 따라 초기화 함수
            function setInitialConditions(color) {
                for (var x = 0; x < 14; x++) {
                    for (var y = 0; y < 14; y++) {
                        ctx.strokeStyle = "black";
                        ctx.lineWidth = 1;
                        ctx.strokeRect(
                            boardSize * x + margin,
                            boardSize * y + margin,
                            boardSize,
                            boardSize
                        );
                    }
                }
                if (myColor == "black") {
                    myTurn = true;
                    document.title = "온라인오목:흑돌";
                } else {
                    document.title = "온라인오목:백돌";
                }
            }

            // WebSocket 닫힘 이벤트 처리 함수
            function handleSocketClose() {
                writing("서버와 연결이 끊어졌습니다.");
                setTimeout(function () {
                    location.reload();
                }, 1000);
            }

            // 보드에 돌 그리는 함수
            function draw(position, color) {
                if (position != "-1") {
                    audio1.play();
                    ctx.fillStyle = color;
                    ctx.lineWidth = 2;
                    strokeStyle = "gray";
                    ctx.beginPath();
                    ctx.arc(
                        (position % Math.sqrt(225)) * boardSize + margin,
                        (Math.floor(position / Math.sqrt(225))) * boardSize + margin,
                        canvas.width / 40,
                        0,
                        Math.PI * 2
                    );
                    ctx.stroke();
                    ctx.fill();
                }
            }

            // 출력 텍스트 업데이트 함수
            function writing(txt) {
                document.getElementById("output").innerText = txt;
            }

            // 타이머 시작 함수
            async function startTimer(Color) {
                var seconds = 60;

                function wait(ms) {
                    return new Promise((resolve) => {
                        setTimeout(resolve, ms);
                    });
                }

                while (seconds >= 0) {
                    seconds = (myTurn ? seconds : 60);
                    writing(Color + (myTurn ? ' ' + seconds : ''));
                    await wait(1000);
                    seconds--;
                }
            }
        };
    </script>
</body>

</html>